<!DOCTYPE HTML>
<html>
<head>
  <title>Online Editor</title>
  <style type="text/css">
    html, body, iframe {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <link href="../../../favicon.ico" rel="icon"/>
  <link href="../../../assets/styles/preinit.css" rel="stylesheet"/>
</head>
<body class="ti-loading">
  <div id="placeholder"></div>
</body>
<script type="text/javascript">
  (function() {
    function loadScripts(scripts, version) {
      var firstScript = document.scripts[0];
      var src, script;

      // Watch scripts load in IE
      function stateChange() {
        // Execute as many scripts in order as we can
        var pendingScript;
        while (pendingScripts[0] && pendingScripts[0].readyState == 'loaded') {
          pendingScript = pendingScripts.shift();
          // avoid future loading events from this script (eg, if src changes)
          pendingScript.onreadystatechange = null;
          // can't just appendChild, old IE bug if element isn't closed
          firstScript.parentNode.insertBefore(pendingScript, firstScript);
        }
      }

      // loop through our script urls
      while (src = scripts.shift()) {
        if (version) {
          src += '?' + version;
        }

        if ('async' in firstScript) { // modern browsers
          script = document.createElement('script');
          script.async = false;
          script.src = src;
          document.head.appendChild(script);
        } else if (firstScript.readyState) { // IE<10
          // create a script and add it to our todo pile
          script = document.createElement('script');
          pendingScripts.push(script);
          // listen for state changes
          script.onreadystatechange = stateChange;
          // must set src AFTER adding onreadystatechange listener
          // else weâ€™ll miss the loaded event for cached scripts
          script.src = src;
        } else { // fall back to defer
          document.write('<script src="' + src + '" defer></'+'script>');
        }
      }
    }

    function getFileExtension(fileName) {
      fileName = fileName || '';
      return fileName.substring(fileName.lastIndexOf(".") + 1).trim().toLowerCase();
    }

    function getDocumentType(ext) {
      if ('.doc.docx.docm.dot.dotx.dotm.odt.fodt.ott.rtf.txt.html.htm.mht.pdf.djvu.fb2.epub.xps'.indexOf(ext) != -1)
        return 'text';
      if ('.xls.xlsx.xlsm.xlt.xltx.xltm.ods.fods.ots.csv'.indexOf(ext) != -1)
        return 'spreadsheet';
      if ('.pps.ppsx.ppsm.ppt.pptx.pptm.pot.potx.potm.odp.fodp.otp'.indexOf(ext) != -1)
        return 'presentation';
      return null;
    }

    var hash = (location.search || '').substr(1);

    if (!hash) {
      alert('Incorrect input parameters.');
      return;
    }

    var config;

    try {
      config = JSON.parse(decodeURI(atob(hash)));
    } catch(e) {
      alert('Incorrect input parameters.');
      return;
    }

    if (!config) {
      alert('Incorrect input parameters.');
      return;
    }

    var ext = getFileExtension(config.DocumentTitle);

    var cfg = {
      height: '100%',
      type: 'desktop',
      width: '100%',
      document: {
        fileType: ext,
        key: config.Key,
        title: config.DocumentTitle,
        url: config.DocumentUrl,
        permissions: {
          edit: false,
          review: true
        }
      },
      documentType: getDocumentType(ext),
      editorConfig: {
        lang: (config.Lang || '').replace('_', '-'),
        callbackUrl: config.CallbackUrl,
        user: config.User,
        mode: 'edit',
        customization: {
          showReviewChanges: true,
          autosave: false,
          logo: {
            image: config.LogoUrl,
            imageEmbedded: config.LogoUrl,
            url: config.RootUrl
          }
        }
      }
    };

    document.title = config.DocumentName || config.DocumentTitle;

    loadScripts([config.OnlyOfficeUrl + '/web-apps/apps/api/documents/api.js']);

    window.addEventListener('load', function() {
      document.body.className = (document.body.className || '').replace('ti-loading', '');
      try {
        var docEditor = new DocsAPI.DocEditor("placeholder", cfg);
      } catch(e) {
        alert('Could not run the Online Editor app. Please contact the support team.');
      }
    });
  })();
</script>
</html>
